<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HK Store — Inventory (PWA)</title>
  <meta name="theme-color" content="#5B2A6E" />
  <style>
    /* Light theme + Six Senses accent ready (override --brand/--brand2 with exact codes) */
    :root{
      --bg: #ffffff;            /* white requested */
      --card:#ffffff;
      --muted:#4a5568;          /* slate-ish for text */
      --text:#111827;           /* near-black */
      --brand:#5B2A6E;          /* placeholder Six Senses Laamu purple */
      --brand2:#7C4A8E;         /* lighter accent */
      --pos:#065f46; --neg:#b91c1c; --info:#1f2937;
      --border: rgba(0,0,0,0.08);
      --row:#fafafa;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji','Segoe UI Emoji';background:var(--bg);color:var(--text)}
    .wrap{max-width:1300px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(145deg,var(--brand),var(--brand2));box-shadow:0 4px 16px rgba(91,42,110,.25)}
    h1{font-size:18px;margin:0;font-weight:800;letter-spacing:.3px}
    .badge{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 4px 20px rgba(17,24,39,.04)}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;padding:12px;overflow-x:auto;-webkit-overflow-scrolling:touch}.toolbar>*{flex:0 0 auto}
    .toolbar input,.toolbar select{height:40px}
    .btn{height:40px;padding:0 14px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;line-height:1;text-align:center;vertical-align:middle}
    .btn:hover{background:#f8fafc}
    .btn.primary{background:linear-gradient(145deg,var(--brand2),var(--brand));border:none;color:#fff}
    .btn.small{height:32px;padding:0 10px}
    .btn.ghost{background:#fff}

    .tablewrap{padding:0 12px 12px; overflow:auto}
    .table{width:100%;min-width:900px;border-collapse:separate;border-spacing:0 4px}
    .table thead th{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:#6b7280;text-align:left;padding:4px 8px;white-space:nowrap} .table td{font-size:13px} 
    .table tbody tr{background:var(--row);border:1px solid var(--border)}
    .table tbody tr td{padding:6px 8px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);vertical-align:top;line-height:1.2}
    .table tbody tr td:first-child{border-left:1px solid var(--border);border-radius:12px 0 0 12px}
    .table tbody tr td:last-child{border-right:1px solid var(--border);border-radius:0 12px 12px 0}

    input, select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text)}
    input::placeholder{color:#9ca3af}
    .right{display:flex;gap:8px;align-items:center}
    .pill{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border);color:#6b7280;background:#fff}
    .muted{color:#6b7280}
    .footer{margin:18px 0;color:#6b7280;font-size:12px}
    dialog{border:none;border-radius:16px;background:#ffffff;color:var(--text);padding:0;box-shadow:0 16px 48px rgba(0,0,0,.15)}
    dialog .head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border)}
    dialog .content{padding:16px}
    dialog form{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    dialog label{font-size:12px;color:#6b7280}
    dialog .actions{display:flex;justify-content:space-between;gap:8px;padding:12px 16px;border-top:1px solid var(--border)}
    .scroll{max-height:340px;overflow:auto;padding-right:6px}
    .hide{display:none}
    @media (max-width:900px){dialog form{grid-template-columns:1fr}}@media (max-width:700px){.admin-only{display:none !important} header{flex-wrap:wrap;gap:8px} .right{width:100%;justify-content:flex-start;gap:6px} h1{font-size:16px} .btn{height:36px;padding:0 10px} .table{min-width:900px} .tablewrap{-webkit-overflow-scrolling:touch}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden></div>
        <div>
          <h1>HK Store — Inventory</h1>
          <div class="muted" style="font-size:12px">HK Main Store • HK Chemical Store • Occupancy‑aware Reorder</div>
        </div>
      </div>
      <div class="right">
        <span class="pill admin-only" id="installState">PWA</span>
        <button class="btn admin-only" id="installBtn" title="Install app" disabled>Install</button>
        <button class="btn admin-only" id="downloadSW" title="Save service worker file">Download sw.js</button>
        <button class="btn admin-only" id="copySW" title="Copy service worker code">Copy sw.js</button>
        <button class="btn admin-only" id="checkUpdate" title="Force update on this device">Update</button><button class="btn primary" id="occBtn" title="Set last 16 days occupancy">Occupancy</button>
        <button class="btn primary" id="levelsBtn" title="Reorder levels mapping">Levels</button>
        <button class="btn primary" id="monthlyBtn" title="Month close & snapshots">Monthly</button>
      </div>
    </header>

    <section class="card">
      <div class="toolbar">
        <select id="filterStore" title="Store">
          <option value="">All Stores</option>
          <option>HK Main Store</option>
          <option>HK Chemical Store</option>
        </select>
        <input id="search" placeholder="Search (barcode, article, name, category, rack)…" />
        <select id="filterStatus" title="Stock status">
          <option value="">All stock</option>
          <option value="low">Low / below adjusted reorder</option>
          <option value="ok">Healthy</option>
        </select>
        <button class="btn primary" id="quickScan">Quick Scan</button>
        <button class="btn primary" id="addItem">Add item</button>
        <button class="btn primary" id="exportBtn">Export CSV</button>
        <label class="btn primary" for="importFile" style="cursor:pointer">Import CSV</label>
        <input id="importFile" type="file" accept=".csv" class="hide" />
        <button class="btn primary" id="backupBtn" title="Download a backup JSON">Backup</button>
        <label class="btn primary" for="restoreFile" style="cursor:pointer">Restore</label>
        <input id="restoreFile" type="file" accept="application/json" class="hide" />
      </div>
      <div class="tablewrap">
        <table class="table" id="table">
          <thead>
            <tr>
              <th>#</th>
              <th>Barcode</th>
              <th>Art No</th>
              <th>Name</th>
              <th>Cat</th>
              <th>On hand</th>
              <th>Rack</th>
              <th>Store</th>
              <th>New (MTD)</th>
              <th>Closing (Last)</th>
              <th style="width:260px">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <div class="footer">
      <span id="swStatus">Offline cache: not configured</span>
      • <span id="occStatus">Occupancy factor: 1.00 (baseline)</span>
      • <span id="monthStatus">No month snapshot yet</span>
      • Tip: Use <strong>±</strong> buttons to adjust stock quickly. Low stock is highlighted automatically.
    </div>
  </div>

  <!-- Add/Edit Dialog -->
  <dialog id="itemDialog">
    <div class="head">
      <div style="font-weight:700">Item</div>
      <button class="btn" id="closeDialog">✕</button>
    </div>
    <div class="content">
      <form id="itemForm">
        <div>
          <label>Store</label>
          <select name="store">
            <option>HK Main Store</option>
            <option>HK Chemical Store</option>
          </select>
        </div>
        <div>
          <label>Barcode</label>
          <input name="barcode" placeholder="Scan or type code" />
        </div>
        <div>
          <label>Article No</label>
          <input name="articleNo" placeholder="Internal code" />
        </div>
        <div>
          <label>Article Name</label>
          <input name="name" required placeholder="e.g., Tissue, Dettol, Mop" />
        </div>
        <div>
          <label>Category</label>
          <input name="category" placeholder="Cleaning, Linen, Amenities…" />
        </div>
        <div>
          <label>Stock On hand</label>
          <input name="onhand" type="number" min="0" step="1" value="0" />
        </div>
        <div>
          <label>Reorder Level</label>
          <select name="velocity">
            <option>VERY SLOW</option>
            <option>SLOW MOVING</option>
            <option selected>NORMAL</option>
            <option>FAST</option>
            <option>VERY FAST</option>
          </select>
        </div>
        <div>
          <label>Location (Rack)</label>
          <input name="rack" placeholder="e.g., A-03-2" />
        </div>
        <div style="grid-column:1/-1">
          <label>Notes</label>
          <input name="notes" placeholder="Vendor, shelf, etc." />
        </div>
        <input type="hidden" name="id" />
      </form>
    </div>
    <div class="actions">
      <button class="btn" id="deleteBtn">Delete</button>
      <div>
        <button class="btn" id="scanBtn">Scan barcode</button>
        <button class="btn primary" id="saveBtn">Save</button>
      </div>
    </div>
  </dialog>

  <!-- Order Dialog (place / receive) -->
  <dialog id="orderDialog">
    <div class="head">
      <div style="font-weight:700">Order</div>
      <button class="btn" id="closeOrder">✕</button>
    </div>
    <div class="content">
      <form id="orderForm">
        <div>
          <label>Open Order Date</label>
          <input type="date" name="openOrderDate" />
        </div>
        <div>
          <label>Open Order Qty</label>
          <input type="number" name="openOrderQty" min="0" step="1" />
        </div>
        <div>
          <label>Expected Receive</label>
          <input type="date" name="expectedReceiveDate" />
        </div>
        <div>
          <label>Last Order Date</label>
          <input type="date" name="lastOrderDate" />
        </div>
        <div>
          <label>Last Receive Date</label>
          <input type="date" name="lastReceiveDate" />
        </div>
        <div style="grid-column:1/-1">
          <label>Supplier / PO Notes</label>
          <input name="orderNotes" placeholder="PO#, supplier, etc." />
        </div>
        <input type="hidden" name="id" />
      </form>
      <div class="muted" style="margin-top:8px">"Mark Received" will add the open order qty to On hand and to <strong>New Stock (MTD)</strong>, clear the open order, and set Last Receive Date.</div>
    </div>
    <div class="actions">
      <div>
        <button class="btn" id="clearOrder">Clear open order</button>
      </div>
      <div>
        <button class="btn" id="markReceived">Mark received</button>
        <button class="btn primary" id="saveOrder">Save</button>
      </div>
    </div>
  </dialog>

  <!-- Occupancy Dialog (calendar dates + scrollable) -->
  <dialog id="occDialog">
    <div class="head">
      <div style="font-weight:700">Occupancy — last 16 days (by date)</div>
      <button class="btn" id="closeOcc">✕</button>
    </div>
    <div class="content">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <label class="muted">End date</label>
        <input id="occEnd" type="date" />
        <button class="btn" id="occAuto">Auto-fill</button>
      </div>
      <div class="scroll">
        <form id="occForm" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <!-- rows injected here: [date][occupancy%] x 16 -->
        </form>
      </div>
      <div class="muted" style="margin-top:8px">Adjusted Reorder = Base (from Level) × (Avg last 16 days ÷ 70% baseline). You can change level bases in <em>Levels</em>.</div>
    </div>
    <div class="actions">
      <button class="btn" id="resetOcc">Reset</button>
      <button class="btn primary" id="saveOcc">Save</button>
    </div>
  </dialog>

  <!-- Levels Dialog (mapping Level → base units) -->
  <dialog id="levelsDialog">
    <div class="head">
      <div style="font-weight:700">Reorder Levels</div>
      <button class="btn" id="closeLevels">✕</button>
    </div>
    <div class="content">
      <div class="scroll">
        <form id="levelsForm" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <!-- Level inputs injected -->
        </form>
      </div>
      <div class="muted" style="margin-top:8px">Set the <strong>base units</strong> per level at 70% occupancy.</div>
    </div>
    <div class="actions">
      <button class="btn" id="resetLevels">Reset defaults</button>
      <button class="btn primary" id="saveLevels">Save</button>
    </div>
  </dialog>

  <!-- Monthly Dialog (closing snapshot + period) -->
  <dialog id="monthlyDialog">
    <div class="head">
      <div style="font-weight:700">Monthly Closing</div>
      <button class="btn" id="closeMonthly">✕</button>
    </div>
    <div class="content">
      <form id="monthlyForm" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <label>Current Period Start</label>
          <input type="date" name="periodStart" />
        </div>
        <div>
          <label>Last Closing Snapshot</label>
          <input type="date" name="lastCloseDate" />
        </div>
      </form>
      <div class="muted" style="margin-top:8px">"Close Month Now" stores each item's current On hand as <strong>Closing (Last Month)</strong> and resets <strong>New Stock (MTD)</strong> to 0.</div>
    </div>
    <div class="actions">
      <button class="btn" id="closeNow">Close Month Now</button>
      <button class="btn primary" id="saveMonthly">Save</button>
    </div>
  </dialog>

  <video id="camera" class="hide" autoplay playsinline></video>

  <script>
    /* ========= Data & DB ========= */
    const DB_NAME = 'hk-inventory-db-v4';
    const STORE = 'items';
    const SETTINGS = 'settings';

    function openDB(){
      return new Promise((resolve, reject)=>{
        const req = indexedDB.open(DB_NAME, 4);
        req.onupgradeneeded = ()=>{
          const db = req.result;
          if(!db.objectStoreNames.contains(STORE)){
            const s = db.createObjectStore(STORE, {keyPath:'id'});
            s.createIndex('store','store',{unique:false});
            s.createIndex('barcode','barcode',{unique:false});
          }
          if(!db.objectStoreNames.contains(SETTINGS)){
            db.createObjectStore(SETTINGS, {keyPath:'key'});
          }
        };
        req.onsuccess=()=>resolve(req.result);
        req.onerror=()=>reject(req.error);
      });
    }
    async function tx(name, mode){const db=await openDB();return db.transaction(name, mode).objectStore(name)}

    const dbApi={
      async getAll(){const s=await tx(STORE,'readonly');return new Promise((res,rej)=>{const r=s.getAll();r.onsuccess=()=>res(r.result||[]);r.onerror=()=>rej(r.error)})},
      async put(item){const s=await tx(STORE,'readwrite');return new Promise((res,rej)=>{item.updated=Date.now();const r=s.put(item);r.onsuccess=()=>res(item);r.onerror=()=>rej(r.error)})},
      async delete(id){const s=await tx(STORE,'readwrite');return new Promise((res,rej)=>{const r=s.delete(id);r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})}
    };

    const setApi={
      async get(key){const s=await tx(SETTINGS,'readonly');return new Promise((res,rej)=>{const r=s.get(key);r.onsuccess=()=>res(r.result?.value);r.onerror=()=>rej(r.error)})},
      async set(key,value){const s=await tx(SETTINGS,'readwrite');return new Promise((res,rej)=>{const r=s.put({key,value});r.onsuccess=()=>res();r.onerror=()=>rej(r.error)})}
    }

    /* ========= Reorder Levels ========= */
    const LEVELS = ['VERY SLOW','SLOW MOVING','NORMAL','FAST','VERY FAST'];
    function getLevelsMap(){
      return JSON.parse(localStorage.getItem('hk_levels_map')||'{"VERY SLOW":4,"SLOW MOVING":7,"NORMAL":10,"FAST":14,"VERY FAST":20}');
    }
    function setLevelsMap(m){ localStorage.setItem('hk_levels_map', JSON.stringify(m)); }

    /* ========= Occupancy (by calendar date) ========= */
    const BASELINE_OCC = 70; // %
    function ymd(d){return d.toISOString().slice(0,10);} // YYYY-MM-DD
    function getOccEntries(){
      const arr = JSON.parse(localStorage.getItem('hk_occ_entries')||'null');
      if(Array.isArray(arr) && arr.length===16) return arr;
      const out=[]; const end=new Date();
      for(let i=15;i>=0;i--){ const dt = new Date(end); dt.setDate(end.getDate()-i); out.push({date: ymd(dt), occ: BASELINE_OCC}); }
      return out;
    }
    function setOccEntries(entries){ localStorage.setItem('hk_occ_entries', JSON.stringify(entries)); }
    function occFactor(){
      const entries = getOccEntries();
      const avg = entries.reduce((a,b)=>a+Number(b.occ||0),0)/entries.length;
      const fac = Math.max(0.25, Math.min(3, avg / BASELINE_OCC));
      return Number(fac.toFixed(2));
    }

    /* ========= Monthly Period ========= */
    async function getMonthly(){
      const periodStart = (await setApi.get('period_start')) || ymd(new Date(new Date().getFullYear(), new Date().getMonth(), 1));
      const lastCloseDate = (await setApi.get('last_close_date')) || '';
      return {periodStart, lastCloseDate};
    }

    /* ========= State & Helpers ========= */
    let items = [];
    let fStore=''; let search=''; let fStatus='';

    const $ = sel => document.querySelector(sel);
    const tbody = $('#tbody');
    function fmtDate(ts){if(!ts) return ''; const d = typeof ts==='string'? new Date(ts) : new Date(ts); if(isNaN(d)) return ''; return d.toLocaleDateString();}

    function baseFromItem(it){
      const map = getLevelsMap();
      if(it.velocity && map[it.velocity]!=null) return map[it.velocity];
      if(typeof it.reorder==='number' && !isNaN(it.reorder)) return it.reorder;
      return map['NORMAL']||10;
    }
    function adjustedReorder(it){ return Math.round(baseFromItem(it) * occFactor()); }
    function rowStatus(it){ return (it.onhand|0) <= adjustedReorder(it) ? 'LOW' : 'OK'; }
    function statusPill(status){
      if(status==='LOW') return '<span class="pill" style="border-color:#fecaca;color:var(--neg)">LOW</span>';
      return '<span class="pill" style="border-color:#bbf7d0;color:var(--pos)">OK</span>';
    }

    function renderRow(it, i){
      return `
        <tr data-id="${it.id}">
          <td>${i+1}</td>
          <td>${it.barcode||''}</td>
          <td>${it.articleNo||''}</td>
          <td><strong>${it.name||''}</strong></td>
          <td>${it.category||''}</td>
          <td>${it.onhand|0} ${statusPill(rowStatus(it))}</td>
          <td>${it.rack||''}</td>
          <td>${it.store||''}</td>
          <td>${it.newStockMTD|0}</td>
          <td>${it.closingLastMonth!=null? it.closingLastMonth: ''}</td>
          <td>
            <button class=\"btn small\" data-act=\"plus\">+1</button>
            <button class=\"btn small\" data-act=\"minus\">−1</button>
            <button class=\"btn small\" data-act=\"edit\">Edit</button>
            <button class=\"btn small\" data-act=\"dup\">Duplicate</button>
          </td>
        </tr>`;
    }

    function render(){
      const q = search.trim().toLowerCase();
      const filtered = items.filter(it=>{
        const text = `${it.barcode||''} ${it.articleNo||''} ${it.name||''} ${it.category||''} ${it.rack||''}`.toLowerCase();
        const byText = !q || text.includes(q);
        const byStore = !fStore || it.store===fStore;
        const byStatus = !fStatus || (fStatus==='low' ? rowStatus(it)==='LOW' : rowStatus(it)==='OK');
        return byText && byStore && byStatus;
      });
      const fac = occFactor();
      $('#occStatus').textContent = `Occupancy factor: ${fac.toFixed(2)}× (baseline 70%)`;
      tbody.innerHTML = filtered.map(renderRow).join('');
    }

    async function load(){ items = await dbApi.getAll(); const {periodStart,lastCloseDate} = await getMonthly(); document.getElementById('monthStatus').textContent = `Period start: ${periodStart}${lastCloseDate? ' • Last close: '+lastCloseDate: ''}`; render(); }

    /* ========= Events (table & toolbar) ========= */
    $('#filterStore').addEventListener('change', e=>{fStore=e.target.value;render()});
    $('#search').addEventListener('input', e=>{search=e.target.value;render()});
    $('#filterStatus').addEventListener('change', e=>{fStatus=e.target.value;render()});
    $('#addItem').addEventListener('click', ()=>openDialog());

    tbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const tr = e.target.closest('tr'); const id = tr.dataset.id; const it = items.find(x=>x.id===id);
      if(btn.dataset.act==='edit') openDialog(it);
      if(btn.dataset.act==='order') openOrder(it);
      if(btn.dataset.act==='plus'){ it.onhand = (it.onhand|0)+1; await dbApi.put(it); await load(); }
      if(btn.dataset.act==='minus'){ it.onhand = Math.max(0,(it.onhand|0)-1); await dbApi.put(it); await load(); }
      if(btn.dataset.act==='dup'){ const copy = {...it, id: crypto.randomUUID(), name: it.name + ' (copy)'}; await dbApi.put(copy); await load(); }
    });

    // Dialog helpers (Item)
    const dlg = $('#itemDialog');
    $('#closeDialog').onclick = ()=>dlg.close();
    $('#saveBtn').onclick = async ()=>{
      const d = Object.fromEntries(new FormData($('#itemForm')).entries());
      const id = d.id || crypto.randomUUID();
      const obj = { id,
        store:d.store||'HK Main Store', barcode:d.barcode?.trim()||'', articleNo:d.articleNo?.trim()||'',
        name:d.name?.trim()||'', category:d.category?.trim()||'', onhand:parseInt(d.onhand||0), velocity:d.velocity||'NORMAL', rack:d.rack?.trim()||'', notes:d.notes?.trim()||'',
        newStockMTD: 0, closingLastMonth: (typeof d.closingLastMonth!=='undefined'? Number(d.closingLastMonth): undefined)
      };
      const existing = items.find(x=>x.id===id);
      if(existing){ obj.newStockMTD = existing.newStockMTD|0; obj.closingLastMonth = existing.closingLastMonth!=null? existing.closingLastMonth : undefined; obj.lastOrderDate=existing.lastOrderDate; obj.openOrderDate=existing.openOrderDate; obj.openOrderQty=existing.openOrderQty; obj.expectedReceiveDate=existing.expectedReceiveDate; obj.lastReceiveDate=existing.lastReceiveDate; obj.orderNotes=existing.orderNotes; }
      await dbApi.put(obj); await load(); dlg.close();
    }
    $('#deleteBtn').onclick = async ()=>{
      const id = new FormData($('#itemForm')).get('id');
      if(id && confirm('Delete this item?')){ await dbApi.delete(id); await load(); dlg.close(); }
    }
    function openDialog(it){
      $('#itemForm').reset();
      const f = $('#itemForm');
      if(it){ f.store.value=it.store||'HK Main Store'; f.barcode.value=it.barcode||''; f.articleNo.value=it.articleNo||''; f.name.value=it.name||''; f.category.value=it.category||''; f.onhand.value=it.onhand||0; f.velocity.value=it.velocity||'NORMAL'; f.rack.value=it.rack||''; f.notes.value=it.notes||''; f.id.value=it.id; }
      else { f.id.value=''; if(fStore) f.store.value=fStore; }
      dlg.showModal();
    }

    /* ========= Order dialog ========= */
    const orderDlg = document.getElementById('orderDialog');
    const orderForm = document.getElementById('orderForm');
    document.getElementById('closeOrder').onclick = ()=>orderDlg.close();

    function openOrder(it){
      orderForm.reset();
      orderForm.elements.id.value = it.id;
      orderForm.elements.openOrderDate.value = it.openOrderDate? ymd(new Date(it.openOrderDate)) : '';
      orderForm.elements.openOrderQty.value = it.openOrderQty||'';
      orderForm.elements.expectedReceiveDate.value = it.expectedReceiveDate? ymd(new Date(it.expectedReceiveDate)) : '';
      orderForm.elements.lastOrderDate.value = it.lastOrderDate? ymd(new Date(it.lastOrderDate)) : '';
      orderForm.elements.lastReceiveDate.value = it.lastReceiveDate? ymd(new Date(it.lastReceiveDate)) : '';
      orderForm.elements.orderNotes.value = it.orderNotes||'';
      orderDlg.showModal();
    }

    document.getElementById('saveOrder').onclick = async ()=>{
      const d = Object.fromEntries(new FormData(orderForm).entries());
      const it = items.find(x=>x.id===d.id); if(!it) return;
      it.openOrderDate = d.openOrderDate||'';
      it.openOrderQty = d.openOrderQty? parseInt(d.openOrderQty): 0;
      it.expectedReceiveDate = d.expectedReceiveDate||'';
      it.lastOrderDate = d.lastOrderDate|| it.lastOrderDate || d.openOrderDate || '';
      it.lastReceiveDate = d.lastReceiveDate|| it.lastReceiveDate || '';
      it.orderNotes = d.orderNotes||'';
      await dbApi.put(it); await load(); orderDlg.close();
    }

    document.getElementById('clearOrder').onclick = async ()=>{
      const d = Object.fromEntries(new FormData(orderForm).entries());
      const it = items.find(x=>x.id===d.id); if(!it) return;
      it.openOrderDate = ''; it.openOrderQty = 0; it.expectedReceiveDate='';
      await dbApi.put(it); await load(); orderDlg.close();
    }

    document.getElementById('markReceived').onclick = async ()=>{
      const d = Object.fromEntries(new FormData(orderForm).entries());
      const it = items.find(x=>x.id===d.id); if(!it) return;
      const qty = parseInt(d.openOrderQty||it.openOrderQty||0);
      if(qty>0){ it.onhand = (it.onhand|0) + qty; it.newStockMTD = (it.newStockMTD|0) + qty; it.lastReceiveDate = ymd(new Date()); }
      // Preserve last order date
      it.lastOrderDate = it.lastOrderDate || d.openOrderDate || '';
      // Clear open order
      it.openOrderDate=''; it.openOrderQty=0; it.expectedReceiveDate='';
      await dbApi.put(it); await load(); orderDlg.close();
    }

    /* ========= Barcode scan ========= */
    const video = $('#camera'); let stream=null; let scanning=false; const scanBtn = $('#scanBtn');
    async function startScan(cb){
      if(!('BarcodeDetector' in window)) { alert('Barcode scan not supported on this device. Enter the code manually.'); return; }
      try{
        const detector = new BarcodeDetector({formats:['ean_13','ean_8','code_128','code_39','qr_code']});
        stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        video.srcObject=stream; video.classList.remove('hide'); scanning=true; if(scanBtn) scanBtn.textContent='Stop scan';
        const loop = async ()=>{
          if(!scanning) return; 
          try{ const bitmap = await createImageBitmap(video);
            const codes = await detector.detect(bitmap);
            if(codes.length){ const code = codes[0].rawValue; 
              cb && cb(code);
              stopScan(); return; 
            }
          }catch(err){ /* ignore */ }
          requestAnimationFrame(loop);
        };
        loop();
      }catch(err){ alert('Cannot access camera. Check permissions.'); }
    }
    function stopScan(){ scanning=false; if(scanBtn) scanBtn.textContent='Scan barcode'; video.classList.add('hide'); if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }
    scanBtn?.addEventListener('click', ()=> scanning?stopScan():startScan(code=>{ $('#itemForm').barcode.value = code; }));

    // Quick scan from toolbar
    document.getElementById('quickScan').addEventListener('click', ()=> scanning?stopScan():startScan(async code=>{
      const found = items.find(x=>x.barcode===code);
      if(found){ openDialog(found); }
      else { openDialog(); $('#itemForm').barcode.value = code; if(fStore) $('#itemForm').store.value=fStore; }
    }));

    /* ========= CSV / Backup ========= */
    function toCSV(rows){
      const head = ['id','store','barcode','articleNo','name','category','onhand','velocity','rack','notes','updated','lastOrderDate','openOrderDate','openOrderQty','expectedReceiveDate','lastReceiveDate','newStockMTD','closingLastMonth'];
      const esc = v => '"'+String(v??'').replace(/\"/g,'""')+'"';
      const out=[head.join(',')];
      rows.forEach(r=> out.push(head.map(k=>esc(r[k])).join(',')) );
      return out.join('\n');
    }
    function fromCSV(text){
      const lines = text.split(/\r?\n/).filter(Boolean);
      const cols = lines.shift().split(',').map(h=>h.replaceAll('"','').trim());
      return lines.map(line=>{
        const raw = line.match(/\"([^\"]|\"\")*\"|[^,]+/g).map(x=>x.replace(/^\"|\"$/g,'').replaceAll('""','"'));
        const obj={}; cols.forEach((c,i)=>obj[c]=raw[i]);
        obj.onhand=parseInt(obj.onhand||0); obj.updated=+obj.updated||Date.now();
        if(!LEVELS.includes(obj.velocity)) obj.velocity='NORMAL';
        obj.openOrderQty = obj.openOrderQty? parseInt(obj.openOrderQty): 0;
        obj.newStockMTD = obj.newStockMTD? parseInt(obj.newStockMTD): 0;
        obj.closingLastMonth = obj.closingLastMonth!==undefined && obj.closingLastMonth!=='' ? parseInt(obj.closingLastMonth) : undefined;
        return obj;
      });
    }
    function download(name, text, type='text/plain'){
      try{
        const blob = new Blob([text], {type});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = name; document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 2000);
      }catch(err){
        // Fallback: open a new tab with the content so user can Save As
        const w = window.open('', '_blank');
        if(w){
          w.document.open();
          const safe = String(text).replace(/[&<>]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[m]));
          w.document.write('<pre>'+safe+'</pre>');
          w.document.close();
        }else{
          alert('Could not trigger download. As a fallback, copy from the console.');
          console.log(text);
        }
      }
    }
    document.getElementById('exportBtn').onclick = ()=> download(`hk-inventory-${new Date().toISOString().slice(0,10)}.csv`, toCSV(items), 'text/csv');
    document.getElementById('backupBtn').onclick = ()=> download(`hk-inventory-backup-${Date.now()}.json`, JSON.stringify(items,null,2), 'application/json');
    document.getElementById('importFile').addEventListener('change', async e=>{
      const file = e.target.files[0]; if(!file) return; const text = await file.text();
      for(const obj of fromCSV(text)){ obj.id=obj.id||crypto.randomUUID(); await dbApi.put(obj); }
      await load(); e.target.value='';
      alert('Import complete');
    });
    document.getElementById('restoreFile').addEventListener('change', async e=>{
      const file=e.target.files[0]; if(!file) return; const json=JSON.parse(await file.text());
      for(const obj of json){ obj.id=obj.id||crypto.randomUUID(); if(!LEVELS.includes(obj.velocity)) obj.velocity='NORMAL'; obj.openOrderQty = obj.openOrderQty? parseInt(obj.openOrderQty): 0; obj.newStockMTD = obj.newStockMTD? parseInt(obj.newStockMTD): 0; if(obj.closingLastMonth!==undefined && obj.closingLastMonth!=='') obj.closingLastMonth=parseInt(obj.closingLastMonth); await dbApi.put(obj); }
      await load(); e.target.value='';
      alert('Restore complete');
    });

    /* ========= Occupancy Dialog glue ========= */
    const occDlg = $('#occDialog');
    const occForm = $('#occForm');
    const occEnd = $('#occEnd');

    function drawOccInputs(endStr){
      occForm.innerHTML = '';
      const entries = getOccEntries();
      const end = endStr ? new Date(endStr) : new Date(entries[entries.length-1].date);
      const rows=[];
      for(let i=15;i>=0;i--){ const dt = new Date(end); dt.setDate(end.getDate()-i); rows.push(ymd(dt)); }
      const map = Object.fromEntries(entries.map(e=>[e.date, e.occ]));
      rows.forEach(date=>{
        const w=document.createElement('div');
        const lab=document.createElement('input'); lab.type='date'; lab.value=date; lab.name=`date-${date}`;
        const inp=document.createElement('input'); inp.type='number'; inp.min=0; inp.max=100; inp.step=1; inp.value=map[date]??BASELINE_OCC; inp.name=`occ-${date}`;
        w.appendChild(lab); w.appendChild(inp); occForm.appendChild(w);
      });
      occEnd.value = rows[rows.length-1];
    }
    function openOcc(){ drawOccInputs(); occDlg.showModal(); }
    document.getElementById('occBtn').addEventListener('click', openOcc);
    document.getElementById('closeOcc').addEventListener('click', ()=>occDlg.close());
    document.getElementById('resetOcc').addEventListener('click', ()=>{ localStorage.removeItem('hk_occ_entries'); drawOccInputs(); render(); });
    document.getElementById('occAuto').addEventListener('click', ()=> drawOccInputs(occEnd.value || ymd(new Date())));
    document.getElementById('saveOcc').addEventListener('click', ()=>{
      const rows = Array.from(occForm.elements).filter(el=>el.name?.startsWith('date-')).map(el=>el.value);
      const out = rows.map(date=>({date, occ: Number((occForm.elements[`occ-${date}`]||{}).value||BASELINE_OCC)}));
      setOccEntries(out); occDlg.close(); render();
    });

    /* ========= Levels dialog glue ========= */
    const levelsDlg = $('#levelsDialog');
    const levelsForm = $('#levelsForm');
    function drawLevels(){
      levelsForm.innerHTML='';
      const map=getLevelsMap();
      LEVELS.forEach(k=>{
        const w=document.createElement('div');
        const lab=document.createElement('label'); lab.textContent=k; lab.style.fontSize='12px'; lab.style.color='#6b7280';
        const inp=document.createElement('input'); inp.type='number'; inp.min=0; inp.step=1; inp.value=map[k]; inp.name=k;
        w.appendChild(lab); w.appendChild(inp); levelsForm.appendChild(w);
      });
    }
    function openLevels(){ drawLevels(); levelsDlg.showModal(); }
    document.getElementById('levelsBtn').addEventListener('click', openLevels);
    document.getElementById('closeLevels').addEventListener('click', ()=>levelsDlg.close());
    document.getElementById('resetLevels').addEventListener('click', ()=>{ localStorage.removeItem('hk_levels_map'); drawLevels(); render(); });
    document.getElementById('saveLevels').addEventListener('click', ()=>{
      const m={}; LEVELS.forEach(k=>{ m[k]= Number(levelsForm.elements[k].value || 0); }); setLevelsMap(m); levelsDlg.close(); render();
    });

    /* ========= Monthly dialog glue ========= */
    const monthlyDlg = document.getElementById('monthlyDialog');
    const monthlyForm = document.getElementById('monthlyForm');
    document.getElementById('monthlyBtn').addEventListener('click', async ()=>{
      const {periodStart,lastCloseDate} = await getMonthly();
      monthlyForm.elements.periodStart.value = periodStart;
      monthlyForm.elements.lastCloseDate.value = lastCloseDate||'';
      monthlyDlg.showModal();
    });
    document.getElementById('closeMonthly').addEventListener('click', ()=>monthlyDlg.close());
    document.getElementById('saveMonthly').addEventListener('click', async ()=>{
      const d = Object.fromEntries(new FormData(monthlyForm).entries());
      if(d.periodStart) await setApi.set('period_start', d.periodStart);
      if(d.lastCloseDate) await setApi.set('last_close_date', d.lastCloseDate);
      monthlyDlg.close();
      const m = await getMonthly(); document.getElementById('monthStatus').textContent = `Period start: ${m.periodStart}${m.lastCloseDate? ' • Last close: '+m.lastCloseDate: ''}`;
    });
    document.getElementById('closeNow').addEventListener('click', async ()=>{
      // Snapshot closing and reset newStockMTD
      for(const it of items){ it.closingLastMonth = it.onhand|0; it.newStockMTD = 0; await dbApi.put(it); }
      const today = ymd(new Date());
      await setApi.set('last_close_date', today);
      await setApi.set('period_start', today);
      monthlyDlg.close();
      const m = await getMonthly(); document.getElementById('monthStatus').textContent = `Period start: ${m.periodStart}${m.lastCloseDate? ' • Last close: '+m.lastCloseDate: ''}`;
      await load();
    });

    /* ========= Service Worker: safe registration ========= */
    const SW_SRC = `
  const VERSION = '2025-08-17-2';
  const CACHE = 'hk-inventory-cache-' + VERSION;
  const ASSETS = [ './', './index.html' ];

  self.addEventListener('install', e=>{
    e.waitUntil(
      caches.open(CACHE)
        .then(c=>c.addAll(ASSETS))
        .then(()=> self.skipWaiting())
    );
  });

  self.addEventListener('activate', e=>{
    e.waitUntil((async ()=>{
      const names = await caches.keys();
      await Promise.all(names.filter(n => n!==CACHE).map(n=>caches.delete(n)));
      await self.clients.claim();
      const clients = await self.clients.matchAll({type:'window', includeUncontrolled:true});
      for (const client of clients){
        client.postMessage({type:'SW_ACTIVATED', version: VERSION});
      }
    })());
  });

  self.addEventListener('message', e=>{
    if(e.data && e.data.type==='SKIP_WAITING') self.skipWaiting();
  });

  self.addEventListener('fetch', e=>{
    const req = e.request;
    // Network-first for navigations (HTML) so new deploys show immediately
    if (req.mode === 'navigate' || req.destination === 'document'){
      e.respondWith((async ()=>{
        try {
          const res = await fetch(req);
          const clone = res.clone();
          const c = await caches.open(CACHE); await c.put('./', clone);
          return res;
        } catch(err){
          return (await caches.match('./')) || (await caches.match('index.html')) || Response.error();
        }
      })());
      return;
    }
    // Cache-first for everything else
    e.respondWith(
      caches.match(req).then(cached => cached || fetch(req).then(res=>{
        if(req.method==='GET' && res.ok){
          const clone = res.clone(); caches.open(CACHE).then(c=>c.put(req, clone));
        }
        return res;
      }))
    );
  });
`;

    const SW_VER = '20250817a';
    async function registerSWIfAvailable(){
      const statusEl = document.getElementById('swStatus');
      if(!('serviceWorker' in navigator)) { statusEl.textContent = 'Offline cache: unsupported'; return; }
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      if(!isSecure){ statusEl.textContent = 'Offline cache: requires https/localhost'; return; }
      const swUrl = new URL('./sw.js', location.href).toString() + '?v=' + SW_VER;
      try{
        const head = await fetch(swUrl, {method:'HEAD'});
        if(!head.ok) throw new Error('sw.js not found');
        const reg = await navigator.serviceWorker.register(swUrl);
        statusEl.textContent = 'Offline cache: enabled (auto‑update)';

        if(reg.waiting){ reg.waiting.postMessage({type:'SKIP_WAITING'}); }

        reg.addEventListener('updatefound', ()=>{
          const nw = reg.installing;
          nw?.addEventListener('statechange', ()=>{
            if(nw.state==='installed' && navigator.serviceWorker.controller){
              statusEl.textContent = 'Update installed — refreshing…';
              location.reload();
            }
          });
        });

        navigator.serviceWorker.addEventListener('controllerchange', ()=>{
          if(!window.__swReloaded){ window.__swReloaded = true; location.reload(); }
        });

        setInterval(()=> reg.update().catch(()=>{}), 60*1000*15);

        navigator.serviceWorker.addEventListener('message', (e)=>{
          if(e.data?.type==='SW_ACTIVATED'){
            console.info('Service worker activated:', e.data.version);
            statusEl.textContent = 'Offline cache: enabled (v '+e.data.version+')';
          }
        }); }
        });
      }catch(err){
        statusEl.textContent = 'Offline cache: sw.js missing (use Download sw.js)';
        console.info('Service Worker not registered:', err.message);
      }
    }

    // Download/Copy buttons (work on Safari/Chrome/Edge)
    document.getElementById('downloadSW').addEventListener('click', ()=> download('sw.js', SW_SRC, 'text/javascript'));
    document.getElementById('copySW').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(SW_SRC); alert('sw.js code copied to clipboard'); }catch(e){ console.log(e); alert('Copy failed — please long-press to select and copy.'); } });
    document.getElementById('checkUpdate').addEventListener('click', async ()=>{
      try{
        const reg = await navigator.serviceWorker.getRegistration();
        if(reg){
          await reg.update();
          if(reg.waiting){ reg.waiting.postMessage({type:'SKIP_WAITING'}); }
        }
        const names = await caches.keys(); await Promise.all(names.map(n=>caches.delete(n)));
      }catch(e){ console.log(e); }
      location.reload();
    });
    (function(){ const params = new URLSearchParams(location.search); if(params.get('admin')==='1'){ document.querySelectorAll('.admin-only').forEach(el=> el.classList.remove('admin-only')); } })(); alert('sw.js code copied to clipboard'); }catch(e){ console.log(e); alert('Copy failed — please long-press to select and copy.'); } });
    /* ========= Self-tests ========= */
    function selfTests(){
      const results = [];
      // CSV round-trip columns
      const sample = [{id:'T1',store:'HK Main Store',barcode:'ABC123',articleNo:'ART-01',name:'Test',category:'Cleaning',onhand:10,velocity:'FAST',rack:'A-1',notes:'N/A',updated:0,lastOrderDate:'2025-07-05',openOrderDate:'2025-08-01',openOrderQty:5,expectedReceiveDate:'2025-08-04',lastReceiveDate:'2025-08-05',newStockMTD:2,closingLastMonth:9}];
      const csv = toCSV(sample); const round = fromCSV(csv);
      results.push({name:'CSV round-trip', pass: round[0].openOrderQty==5 && round[0].closingLastMonth==9});
      // Order receive flow
      const it = {id:'X', onhand:10, newStockMTD:0, openOrderQty:3};
      const before = it.onhand; const qty=it.openOrderQty; it.onhand += qty; it.newStockMTD += qty; it.openOrderQty=0;
      results.push({name:'Receive adds & clears', pass: it.onhand===before+qty && it.newStockMTD===qty && it.openOrderQty===0});
      // Occupancy entries length & factor range
      const occ=getOccEntries(); results.push({name:'16 occ entries', pass: occ.length===16});
      results.push({name:'Occ factor range', pass: occFactor()>=0.25 && occFactor()<=3});
      console.table(results); const allPass = results.every(r=>r.pass);
      const pill = document.createElement('span'); pill.className = 'pill'; pill.textContent = allPass ? 'Self‑tests passed' : 'Self‑tests: check console';
      document.querySelector('.footer').append(' • ', pill);
    }

    // Boot
    (async function(){
      await load();
      selfTests();
      registerSWIfAvailable();
    })();
  </script>
</body>
</html>
